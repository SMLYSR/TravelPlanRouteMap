# 实现任务列表：AI旅行路线规划应用

## 阶段 1：项目基础设施和配置

### 1.1 项目配置和依赖管理
- [x] 1.1.1 配置高德地图 SDK（集成 AMapFoundationKit 和 MAMapKit）
  - 在 Info.plist 中添加高德地图 API Key
  - 配置位置权限描述（NSLocationWhenInUseUsageDescription）
  - 在 AppDelegate 中初始化高德地图服务
  - **验证需求：** 7.6

- [x] 1.1.2 配置 OpenAI API 集成
  - 创建配置文件管理 API Key
  - 实现安全的 API Key 存储机制
  - **验证需求：** 8.4

- [x] 1.1.3 设置项目架构基础
  - 创建 MVVM 架构的文件夹结构（Models, Views, ViewModels, Services, Utils）
  - 配置依赖注入容器
  - **验证需求：** 设计文档架构部分

## 阶段 2：核心数据模型

### 2.1 定义数据模型
- [x] 2.1.1 实现基础数据模型
  - 创建 Coordinate 结构体
  - 创建 TravelMode 枚举
  - 创建 Attraction 结构体（包含 id, name, coordinate, address）
  - 创建 OptimizedRoute 结构体
  - 创建 AccommodationZone 结构体
  - 创建 TravelPlan 结构体
  - 创建 MapRegion 和 MapSpan 结构体
  - **验证需求：** 设计文档数据模型部分

- [x] 2.1.2 实现错误类型定义
  - 创建 TravelPlanError 枚举
  - 实现 LocalizedError 协议
  - 定义所有错误类型和错误消息
  - **验证需求：** 11.1, 11.2, 11.3, 11.4, 11.5

## 阶段 3：UI 设计系统和通用组件

### 3.1 设计系统基础
- [x] 3.1.1 实现颜色系统
  - 创建 Color 扩展（hex 初始化方法）
  - 创建 UIColor 扩展（hex 初始化方法）
  - 定义 AppColors 枚举（primary, secondary, accent, background, text, border）
  - **验证需求：** UI/UX 指南 1.2


- [x] 3.1.2 实现间距和动画系统
  - 创建 Spacing 枚举（xs, sm, md, lg, xl, xxl）
  - 创建 AnimationDuration 枚举（microInteraction, pageTransitionIn, pageTransitionOut, loading, listItem）
  - 创建 HapticFeedback 工具类（light, medium, success, error）
  - **验证需求：** UI/UX 指南 3.2, 4.1, 4.2

### 3.2 通用 UI 组件
- [x] 3.2.1 实现按钮样式
  - 创建 PrimaryButtonStyle
  - 创建 SecondaryButtonStyle
  - **验证需求：** UI/UX 指南 2.1

- [x] 3.2.2 实现输入框组件
  - 创建 CustomTextField 组件
  - 支持图标、占位符和文本绑定
  - **验证需求：** UI/UX 指南 2.2

- [x] 3.2.3 实现卡片组件
  - 创建 AttractionCard 组件
  - 支持序号标记、景点名称、地址显示
  - **验证需求：** UI/UX 指南 2.3

- [x] 3.2.4 实现加载和错误视图
  - 创建 LoadingView 组件（支持 accessibilityReduceMotion）
  - 创建 ErrorView 组件（支持重试操作）
  - 创建 EmptyStateView 组件
  - **验证需求：** UI/UX 指南 2.4, 8.1, 8.2

- [x] 3.2.5 实现导航栏组件
  - 创建 CustomNavigationBar 组件
  - 支持标题、返回按钮
  - **验证需求：** UI/UX 指南 3.1

## 阶段 4：数据持久化层

### 4.1 实现本地存储
- [x] 4.1.1 实现 TravelPlanRepository 协议
  - 定义 savePlan, getLatestPlan, getAllPlans, deletePlan, updatePlan 方法
  - **验证需求：** 10.1, 10.2, 10.3, 10.4, 10.5

- [x] 4.1.2 实现 LocalTravelPlanRepository
  - 使用 UserDefaults 进行数据存储
  - 实现 JSON 编码/解码
  - 实现 CRUD 操作
  - **验证需求：** 10.1, 10.2, 10.3, 10.4, 10.5

- [x] 4.1.3 为数据持久化编写单元测试
  - 测试保存单个计划
  - 测试保存多个计划
  - 测试删除计划
  - 测试更新计划
  - 测试读取不存在的计划
  - **验证需求：** 10.1, 10.2, 10.3, 10.4, 10.5

- [x] 4.1.4 为数据持久化编写属性测试
  - **属性 2：** 目的地保存往返一致性
  - **属性 3：** 出行方式保存一致性
  - **属性 12：** 数据持久化往返一致性
  - **属性 13：** 历史记录增长
  - **属性 15：** 历史记录删除
  - **验证需求：** 1.3, 2.2, 10.1, 10.3, 10.5

## 阶段 5：地图服务层

### 5.1 实现地图服务接口
- [x] 5.1.1 定义 MapService 协议
  - 定义 displayMap, addAttractionMarkers, drawRoute, addAccommodationZones, fitMapToShowAllElements 方法
  - **验证需求：** 7.1, 7.2, 7.3, 7.4, 7.5

- [x] 5.1.2 定义 GeocodingService 协议
  - 定义 geocode 和 searchPOI 方法
  - 创建 GeocodingResult 和 POIResult 数据模型
  - **验证需求：** 1.5, 3.6

### 5.2 实现高德地图服务
- [x] 5.2.1 实现 AMapService
  - 实现地图初始化和显示
  - 配置地图样式（基于 UI/UX 指南）
  - 实现景点标记添加（按游览顺序编号）
  - 实现路线绘制
  - 实现住宿区域标注
  - 实现地图视野自动调整
  - **验证需求：** 7.1, 7.2, 7.3, 7.4, 7.5, 7.6

- [x] 5.2.2 实现自定义地图标注视图
  - 创建 AttractionAnnotationView（渐变背景、序号标签）
  - 实现 MAMapViewDelegate 方法
  - 自定义路线样式（颜色、宽度、圆角）
  - 自定义住宿区域样式（填充色、边框）
  - **验证需求：** UI/UX 指南 5.2, 5.3, 5.4

- [x] 5.2.3 实现 AMapGeocodingService
  - 实现地理编码功能（地址转坐标）
  - 实现 POI 搜索功能（模糊搜索）
  - 处理异步回调和错误
  - **验证需求：** 1.5, 3.6

- [x] 5.2.4 为地图服务编写单元测试
  - 测试景点标记添加
  - 测试路线绘制
  - 测试住宿区域标注
  - 测试地理编码
  - 测试 POI 搜索
  - **验证需求：** 7.1, 7.2, 7.3, 7.4, 1.5, 3.6

- [x] 5.2.5 为地图服务编写属性测试
  - **属性 10：** 地图元素完整性
  - **属性 18：** POI 搜索结果有效性
  - **验证需求：** 7.1, 7.2, 7.3, 7.4, 1.5, 3.6

## 阶段 6：AI 交互层

### 6.1 实现提示词模块
- [x] 6.1.1 定义 PromptProvider 协议
  - 定义 getRouteOptimizationPrompt 方法
  - 定义 getAccommodationRecommendationPrompt 方法
  - 定义 getDurationEstimationPrompt 方法
  - **验证需求：** 8.1, 8.2, 8.3, 8.5

- [x] 6.1.2 实现 PromptModule
  - 实现路线优化提示词生成（包含目的地、景点、出行方式）
  - 实现住宿推荐提示词生成（包含范围限制：步行/公交 1-3km，自驾 3-5km）
  - 实现天数估算提示词生成（综合考虑距离、景点数量、单个景点时间）
  - **验证需求：** 8.2, 8.3, 8.5, 6.6, 5.6

- [x] 6.1.3 为提示词模块编写单元测试
  - 测试路线规划提示词生成
  - 测试住宿推荐提示词生成
  - 测试天数计算提示词生成
  - **验证需求：** 8.2, 8.3, 8.5

- [x] 6.1.4 为提示词模块编写属性测试
  - **属性 11：** 提示词模块完整性
  - **验证需求：** 8.2, 8.3, 8.5

### 6.2 实现 AI Agent
- [x] 6.2.1 定义 AIAgent 协议
  - 定义 optimizeRoute 方法
  - 定义 recommendAccommodations 方法
  - 定义 estimateDuration 方法
  - **验证需求：** 4.1, 5.1, 6.1

- [x] 6.2.2 实现 OpenAI API 数据模型
  - 创建 OpenAIRequest 结构体
  - 创建 Message 结构体
  - 创建 OpenAIResponse 结构体
  - 创建 Choice 结构体
  - **验证需求：** 8.4

- [x] 6.2.3 实现 OpenAIAgent
  - 实现 OpenAI API 调用（使用标准接口格式）
  - 实现路线优化逻辑
  - 实现住宿推荐逻辑
  - 实现天数估算逻辑
  - 处理 API 错误和超时（30秒）
  - **验证需求：** 4.1, 5.1, 6.1, 8.4, 11.3

- [x] 6.2.4 为 AI Agent 编写单元测试（使用 Mock）
  - 测试路线优化（使用模拟 AI 响应）
  - 测试住宿推荐（使用模拟 AI 响应）
  - 测试天数估算（使用模拟 AI 响应）
  - 测试错误处理
  - 测试超时处理
  - **验证需求：** 4.1, 5.1, 6.1, 11.3

## 阶段 7：业务逻辑层

### 7.1 实现路线规划服务
- [x] 7.1.1 定义 RoutePlanningService 协议
  - 定义 planRoute 方法
  - **验证需求：** 4.1, 4.2, 4.3, 4.4, 4.5

- [x] 7.1.2 实现 DefaultRoutePlanningService
  - 实现完整的路线规划流程（地理编码 → 路线优化 → 距离计算 → 天数估算 → 住宿推荐）
  - 集成 AI Agent 和提示词模块
  - 处理地理编码失败的景点
  - 计算路线总距离
  - **验证需求：** 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 6.1

- [x] 7.1.3 为路线规划服务编写单元测试
  - 测试 2 个景点的规划
  - 测试 10 个景点的规划
  - 测试不同出行方式的规划
  - 测试规划失败场景
  - 测试地理编码失败处理
  - **验证需求：** 4.1, 4.2, 4.3, 4.4, 4.5

- [x] 7.1.4 为路线规划服务编写属性测试
  - **属性 5：** 路线规划返回有效排列
  - **属性 6：** 路线优化减少距离
  - **属性 7：** 规划结果完整性
  - **属性 8：** 推荐天数为正整数
  - **属性 9：** 住宿区域数量与天数关系
  - **属性 17：** 住宿区域范围限制
  - **验证需求：** 4.1, 4.2, 4.4, 5.1, 6.2, 6.6

## 阶段 8：视图模型层

### 8.1 实现目的地输入 ViewModel
- [x] 8.1.1 创建 DestinationViewModel
  - 实现目的地输入状态管理
  - 实现目的地搜索（使用高德地理编码）
  - 实现搜索结果选择
  - 实现输入验证（非空验证）
  - **验证需求：** 1.1, 1.2, 1.3, 1.4, 1.5

- [x] 8.1.2 为 DestinationViewModel 编写单元测试
  - 测试空字符串输入验证
  - 测试纯空白字符串输入验证
  - 测试有效输入
  - 测试搜索功能
  - 测试选择功能
  - **验证需求：** 1.2, 1.4

- [x] 8.1.3 为 DestinationViewModel 编写属性测试
  - **属性 1：** 输入验证一致性
  - **验证需求：** 1.2

### 8.2 实现景点输入 ViewModel
- [x] 8.2.1 创建 AttractionViewModel
  - 实现景点列表管理
  - 实现景点搜索（使用高德 POI 搜索）
  - 实现景点添加（最多 10 个）
  - 实现景点删除
  - 实现出行方式选择
  - 实现输入验证（至少 2 个景点）
  - **验证需求：** 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6

- [x] 8.2.2 为 AttractionViewModel 编写单元测试
  - 测试景点添加
  - 测试景点删除
  - 测试最多 10 个景点限制
  - 测试至少 2 个景点验证
  - 测试 POI 搜索
  - 测试出行方式选择
  - **验证需求：** 3.2, 3.3, 3.4, 3.5, 3.6

- [x] 8.2.3 为 AttractionViewModel 编写属性测试
  - **属性 4：** 景点列表最小数量验证
  - **验证需求：** 3.4

### 8.3 实现结果展示 ViewModel
- [x] 8.3.1 创建 ResultViewModel
  - 实现路线规划状态管理
  - 实现加载状态管理
  - 实现错误处理
  - 集成路线规划服务
  - 集成数据持久化
  - **验证需求：** 4.1, 4.4, 4.5, 10.1

- [x] 8.3.2 为 ResultViewModel 编写单元测试
  - 测试路线规划成功场景
  - 测试路线规划失败场景
  - 测试加载状态管理
  - 测试错误处理
  - 测试数据保存
  - **验证需求：** 4.4, 4.5, 10.1

## 阶段 9：视图层

### 9.1 实现目的地输入视图
- [x] 9.1.1 创建 DestinationInputView
  - 实现目的地输入界面
  - 实现搜索结果列表
  - 实现选择反馈
  - 实现错误提示
  - 集成 DestinationViewModel
  - **验证需求：** 1.1, 1.2, 1.3, 1.4, 1.5, 9.1, 9.2, 9.3, 9.4, 9.5

### 9.2 实现出行方式选择视图
- [x] 9.2.1 创建 TravelModeSelectionView
  - 实现出行方式选择界面（步行、公共交通、自驾）
  - 实现默认选择（自驾）
  - 实现跳过功能
  - **验证需求：** 2.1, 2.2, 2.3, 2.4, 2.5, 9.1, 9.2, 9.3, 9.4, 9.5

### 9.3 实现景点输入视图
- [x] 9.3.1 创建 AttractionInputView
  - 实现景点输入界面
  - 实现 POI 搜索结果列表
  - 实现景点列表展示（使用 AttractionCard）
  - 实现景点删除功能
  - 实现添加限制提示（最多 10 个）
  - 实现提交验证（至少 2 个）
  - 集成 AttractionViewModel
  - **验证需求：** 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 9.1, 9.2, 9.3, 9.4, 9.5

### 9.4 实现结果展示视图
- [x] 9.4.1 创建 ResultView
  - 实现规划结果展示界面
  - 显示推荐游玩天数
  - 显示景点游览顺序
  - 显示住宿区域推荐
  - 显示总距离
  - 集成地图显示
  - 实现加载状态（使用 LoadingView）
  - 实现错误状态（使用 ErrorView）
  - 集成 ResultViewModel
  - **验证需求：** 4.4, 5.5, 6.5, 7.1, 7.2, 7.3, 7.4, 7.5, 9.1, 9.2, 9.3, 9.4, 9.5

### 9.5 实现地图视图包装器
- [x] 9.5.1 创建 MapViewWrapper（UIViewRepresentable）
  - 包装 MAMapView 以在 SwiftUI 中使用
  - 实现 Coordinator 处理地图代理方法
  - 集成 MapService
  - **验证需求：** 7.1, 7.2, 7.3, 7.4, 7.5

### 9.6 实现历史记录视图
- [x] 9.6.1 创建 HistoryView
  - 实现历史记录列表
  - 显示目的地、景点数量、创建时间
  - 实现删除功能
  - 实现查看详情功能
  - **验证需求：** 10.2, 10.4, 10.5

## 阶段 10：导航和应用入口

### 10.1 实现导航协调器
- [x] 10.1.1 创建 AppCoordinator
  - 实现页面导航流程（目的地 → 出行方式 → 景点 → 结果）
  - 管理导航状态
  - **验证需求：** 设计文档架构部分

### 10.2 实现应用入口
- [x] 10.2.1 更新 TravelPlanRouteMapApp
  - 配置依赖注入
  - 初始化高德地图服务
  - 设置根视图
  - **验证需求：** 设计文档架构部分

- [x] 10.2.2 实现 ContentView
  - 实现主界面（历史记录 + 新建规划）
  - 集成导航协调器
  - **验证需求：** 设计文档架构部分

## 阶段 11：错误处理和用户体验优化

### 11.1 实现全局错误处理
- [x] 11.1.1 创建 ErrorHandler
  - 实现统一的错误处理逻辑
  - 实现错误消息映射
  - 实现重试机制
  - **验证需求：** 11.1, 11.2, 11.3, 11.4, 11.5

- [x] 11.1.2 为错误处理编写单元测试
  - 测试网络错误处理
  - 测试地图加载错误处理
  - 测试 AI 规划超时处理
  - 测试无效输入错误消息
  - **验证需求：** 11.1, 11.2, 11.3, 11.4

- [x] 11.1.3 为错误处理编写属性测试
  - **属性 16：** 无效输入错误消息
  - **验证需求：** 11.4

### 11.2 实现用户体验优化
- [x] 11.2.1 添加触觉反馈
  - 在按钮点击时添加轻触觉反馈
  - 在重要操作时添加中等触觉反馈
  - 在成功/失败时添加通知触觉反馈
  - **验证需求：** UI/UX 指南 4.2

- [x] 11.2.2 优化动画效果
  - 确保所有动画检查 accessibilityReduceMotion
  - 优化页面过渡动画
  - 优化列表项动画
  - **验证需求：** UI/UX 指南 4.1, 6.1

- [x] 11.2.3 优化性能
  - 使用 LazyVStack 优化列表
  - 使用 CAGradientLayer 优化渐变
  - 实现地图标注复用
  - **验证需求：** UI/UX 指南 7.1, 7.2, 7.3

## 阶段 12：集成测试和端到端测试

### 12.1 集成测试
- [x] 12.1.1 编写完整流程集成测试
  - 测试从输入目的地到显示规划结果的完整流程
  - 验证所有组件正确协作
  - **验证需求：** 所有需求

- [x] 12.1.2 编写地图集成测试
  - 验证高德地图 SDK 正确集成
  - 验证地图元素正确显示
  - **验证需求：** 7.1, 7.2, 7.3, 7.4, 7.5, 7.6

- [x] 12.1.3 编写 AI 集成测试
  - 使用模拟 AI 响应测试规划流程
  - 验证提示词正确传递给 AI
  - **验证需求：** 4.1, 5.1, 6.1, 8.2, 8.3, 8.5

### 12.2 端到端测试
- [x] 12.2.1 编写 UI 测试
  - 测试目的地输入流程
  - 测试景点输入流程
  - 测试结果展示流程
  - 测试历史记录流程
  - **验证需求：** 所有需求

## 阶段 13：文档和交付

### 13.1 代码文档
- [x] 13.1.1 添加代码注释
  - 为所有公共接口添加文档注释
  - 为复杂逻辑添加解释注释
  - **验证需求：** 最佳实践

### 13.2 用户文档
- [x] 13.2.1 创建用户指南
  - 编写应用使用说明
  - 编写常见问题解答
  - **验证需求：** 最佳实践

### 13.3 交付前检查
- [x] 13.3.1 执行交付前检查清单
  - 检查视觉质量（图标、渐变、阴影、圆角）
  - 检查交互体验（视觉反馈、触摸目标、加载状态、错误状态）
  - 检查动画效果（时长、减弱动画支持、缓动函数）
  - 检查无障碍（对比度、VoiceOver、触摸目标、动态字体）
  - 检查性能（列表优化、地图优化、渐变优化）
  - 检查响应式（不同设备尺寸、横竖屏）
  - **验证需求：** UI/UX 指南 10

---

## 任务执行说明

1. **按阶段顺序执行**：每个阶段的任务应按顺序完成，确保依赖关系正确
2. **测试驱动开发**：每个功能实现后立即编写单元测试和属性测试
3. **增量开发**：每完成一个小任务就进行测试和验证
4. **代码审查**：每个阶段完成后进行代码审查
5. **文档同步**：代码实现时同步更新文档注释

## 属性测试说明

所有属性测试必须：
- 使用 SwiftCheck 或类似的属性测试库
- 每个属性测试至少运行 100 次迭代
- 在测试注释中引用对应的设计文档属性编号
- 使用格式：`// Feature: ai-travel-route-planner, Property {编号}: {属性文本}`

## 验证需求映射

每个任务都标注了对应的需求编号，确保所有需求都被覆盖：
- 需求 1：目的地输入
- 需求 2：出行方式选择
- 需求 3：景点输入
- 需求 4：AI 路线规划
- 需求 5：推荐游玩天数
- 需求 6：住宿区域推荐
- 需求 7：地图可视化展示
- 需求 8：提示词模块管理
- 需求 9：用户界面设计
- 需求 10：数据持久化
- 需求 11：错误处理
